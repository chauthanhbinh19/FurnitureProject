@using FurnitureProject.Models.DTO
@{
    ViewData["Title"] = "Trang chủ dashboard";
    var topCustomers = ViewBag.TopCustomers as List<(Guid UserId, string FullName, int OrderCount)>;
    var topProducts = ViewBag.TopProducts as List<ProductDTO>;
}
<div class="container-fluid px-4">
    <div class="d-flex items-center align-items-center gap-4">
        <!-- Left arrow -->
        <button class="p-2 rounded-3 card">
            <i class="fa-solid fa-angle-left"></i>
        </button>
        @* <button class="card px-4 py-2 rounded-md border border-gray-300 hover:bg-gray-100">Recently Applied</button> *@
        <div class="col-md-1-5">
            <form method="get" asp-action="Index" class="d-flex gap-2 flex-wrap">
                <input type="hidden" name="range" value="3" />
                <button type="submit" 
                        class="btn card @(ViewBag.SelectedRange == 3 ? "border-primary text-primary" : "")" 
                        style="width: 100%;">3 ngày trước</button>
            </form>
        </div>
        <div class="col-md-1-5">
            <form method="get" asp-action="Index">
                <input type="hidden" name="range" value="7" />
                <button type="submit" 
                        class="btn card @(ViewBag.SelectedRange == 7 ? "border-primary text-primary" : "")" 
                        style="width: 100%;">7 ngày trước</button>
            </form>
        </div>
        <div class="col-md-1-5">
            <form method="get" asp-action="Index">
                <input type="hidden" name="range" value="15" />
                <button type="submit" 
                        class="btn card @(ViewBag.SelectedRange == 15 ? "border-primary text-primary" : "")" 
                        style="width:100%">15 ngày trước</button>
            </form>
        </div>
        <div class="col-md-1-5">
            <form method="get" asp-action="Index">
                <input type="hidden" name="range" value="30" />
                <button type="submit" 
                        class="btn card @(ViewBag.SelectedRange == 30 ? "border-primary text-primary" : "")" 
                        style="width: 100%;">30 ngày trước</button>
            </form>
        </div>
        <div class="col-md-1-5">
            <form method="get" asp-action="Index">
                <input type="hidden" name="range" value="365" />
                <button type="submit" 
                        class="btn card @(ViewBag.SelectedRange == 365 ? "border-primary text-primary" : "")" 
                        style="width:100%;">Năm ngoái</button>
            </form>
        </div>
        
        <!-- Right arrow -->
        <button class="p-2 rounded-3 card">
            <i class="fa-solid fa-angle-right"></i>
        </button>

        <!-- Icon buttons -->
        <button class="px-4 py-2 rounded-3 card">
            <i class="fa-solid fa-calendar"></i>
        </button>
    </div>
</div>
<div class="container-fluid px-4 py-4">
    <div class="row gx-4 gy-3 justify-content-between">
        <div class="col-md-2-5">
            <div class="card p-3 flex-column flex-column gap-2 card-box">
                <div class="d-flex align-items-center gap-2">
                   <i class="fa-solid fa-money-bills text-conflowerblue"></i>
                    <span class="fw-medium">Tổng doanh thu</span>
                </div>
                <span class="fw-bold fs-5">@ViewBag.TotalRevenue.ToString("N0") ₫</span>
                <span class="text-success form-control">+16% in last 7 days</span>
            </div>
        </div>
        <div class="col-md-2-5">
                <div class="card p-3 flex-column flex-column gap-2 card-box">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-user-group text-conflowerblue"></i>
                        <span class="fw-medium">Tổng khách hàng</span>
                </div>
                <span class="fw-bold fs-5">@ViewBag.TotalUsers</span>
                    <span class="text-danger form-control">-10% in last 7 days</span>
            </div>
        </div>
        <div class="col-md-2-5">
                <div class="card p-3 flex-column flex-column gap-2 card-box">
                    <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-file-invoice text-conflowerblue"></i>
                        <span class="fw-medium">Tổng số giao dịch</span>
                </div>
                <span class="fw-bold fs-5">@ViewBag.TotalTransactions</span>
                    <span class="text-success form-control">+10% increase</span>
            </div>
        </div>
        <div class="col-md-2-5">
                <div class="card p-3 flex-column flex-column gap-2 card-box">
                    <div class="d-flex align-items-center gap-2">
                    <i class="fa-solid fa-boxes-stacked text-conflowerblue"></i>
                        <span class="fw-medium">Tổng sản phẩm</span>
                </div>
                <span class="fw-bold fs-5">@ViewBag.TotalProducts</span>
                    <span class="text-success form-control">+5% increase</span>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid px-4">
    <div class="row gx-4 gy-3 d-flex align-items-stretch justify-content-between">
        <div class="col-md-6-5 h-100">
            <div class="card p-3 flex-column flex-column gap-2 card-box">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fs-5 d-flex align-items-center gap-2">
                            <i class="fas fa-user text-conflowerblue"></i>
                            <span class="fw-medium">Khách hàng tiêu biểu</span>
                        </div>
                        <div>
                            Khách hàng mua hàng nhiều nhất trong @ViewBag.SelectedRange ngày
                        </div>
                    </div>
                    <div class="d-flex flex-column justify-content-end">
                        <a asp-action="Index" asp-controller="AdminUser" class="px-2 py-2 rounded-3 card">
                            <i class="fa-solid fa-arrows-turn-right fs-5"></i>
                        </a>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-3">
                    @foreach (var user in (List<UserDTO>)ViewBag.TopCustomers)
                    {
                        <div class="col-md-3-5 d-flex flex-row gap-2 py-2 px-2 card">
                            <img src="~/images/polar-bear.png" alt="Avatar" class="rounded-5" width="50" height="50">
                            <div class="d-flex flex-column">
                                <div class="fw-medium"
                                     style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; font-size: 0.95rem;">
                                    @user.FullName
                                </div>
                                <div class="fw-light">Mua: @user.OrderCount</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-5 h-100">
            <div class="card p-3 flex-column flex-column gap-2 card-box">
                <span class="fw-medium fs-5">Đơn hàng theo trạng thái</span>
                <canvas id="orderStatusChart" height="175"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid px-4 mt-4 mb-4">
    <div class="row gx-4 gy-3 justify-content-between">
        <div class="col-md-6-5">
            <div class="card p-3 flex-column flex-column gap-2 card-box">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="fs-5 d-flex align-items-center gap-2">
                            <i class="fas fa-boxes-stacked text-conflowerblue"></i>
                            <span class="fw-medium">Sản phẩm tiêu biểu</span>
                        </div>
                        <div>
                            Sản phẩm được mua nhiều nhất trong @ViewBag.SelectedRange ngày
                        </div>
                    </div>
                    <div class="d-flex flex-column justify-content-end">
                        <a asp-action="Index" asp-controller="AdminProduct" class="px-2 py-2 rounded-3 card">
                            <i class="fa-solid fa-arrows-turn-right fs-5"></i>
                        </a>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-3">
                    @foreach(var product in topProducts)
                    {
                        <div class="col-md-3-5 d-flex flex-column gap-2 py-3 px-3 card">
                            <div class="d-flex justify-content-center" style="aspect-ratio: 1/1; width: 100%; overflow:hidden;">
                                <img src="@product.ImageUrls[0]" alt="Avatar" class="rounded-5" style="object-fit:cover; width: 100%; height: 100%; display:block; border-radius: 10px;">
                            </div>
                            <div class="d-flex flex-column">
                                <div class="fw-medium"
                                     style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; font-size: 0.95rem;">
                                    @product.Name
                                </div>
                                <div class="fw-light">Đã bán: @product.Quantity</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card p-3 flex-column flex-column gap-2 card-box">
                <span class="fw-medium fs-5">Doanh thu theo ngày</span>
                <canvas id="revenueLineChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Chart script -->
@section Scripts{
    <script>
        const ctx = document.getElementById('orderStatusChart').getContext('2d');

        const labels = [];
        const data = [];

        @* Tạo dữ liệu từ ViewBag *@
        @if (ViewBag.OrderStatusCounts != null)
        {
                foreach (var item in (Dictionary<string, int>)ViewBag.OrderStatusCounts)
                {
                        <text>
                            labels.push('@item.Key');
                            data.push(@item.Value);
                        </text>
                }
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số lượng đơn',
                    data: data,
                    backgroundColor: [
                        '#f6c23e', // Pending
                        '#36b9cc', // Confirmed
                        '#4e73df', // Processing
                        '#1cc88a', // Shipping
                        '#858796', // Completed
                        '#e74a3b'  // Cancelled
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'x',
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
    <script>
        const revenueLabels = [];
        const revenueData = [];

        @* Tạo dữ liệu từ ViewBag.RevenueByDate *@
        @if (ViewBag.RevenueByDate != null)
        {
                foreach (var item in (Dictionary<string, decimal>)ViewBag.RevenueByDate)
                {
                        <text>
                            revenueLabels.push("@item.Key");
                            revenueData.push(@item.Value);
                        </text>
                }
        }

        new Chart(document.getElementById('revenueLineChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Doanh thu theo ngày',
                    data: revenueData,
                    fill: true,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            // display: true,
                            text: 'VNĐ'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' ₫';
                            }
                        }
                    },
                    x: {
                        title: {
                            // display: true,
                            text: 'Ngày'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + ' ₫';
                            }
                        }
                    }
                }
            }
        });
    </script>
}
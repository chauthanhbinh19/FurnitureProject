@model FurnitureProject.Models.DTO.UserDTO
@* @using WebApplication1.Enums *@
@{
    ViewData["Title"] = "Thêm người dùng";
}
<div class="title-box">
    <div class="text-box">
        <span class="title ms-2">Thêm người dùng</span>
    </div>
</div>
<div class="container mt-4 pb-5">
    <form asp-controller="AdminUser" asp-action="Create" method="post">
        <div class="row gx-4 gy-3 justify-content-between">
            <div class="col-md-12">
                <div class="row gx-4 gy-3 justify-content-between">
                    <div class="card shadow mb-3">
                        <div class="card-header text-black fs-5 d-flex align-items-center gap-2">
                            <i class="fas fa-user-circle text-conflowerblue"></i>
                            <span>Thông tin người dùng</span>
                        </div>
                        <div class="card-body">
                            <div class="row justify-content-between mb-3">
                                <div class="col-md-3-5">
                                    <label asp-for="FullName" class="form-label fw-medium"></label>
                                    <input asp-for="FullName" class="form-control custom-gray-input" />
                                    <span asp-validation-for="FullName" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3-5">
                                    <label asp-for="Email" class="form-label fw-medium"></label>
                                    <input asp-for="Email" class="form-control custom-gray-input" />
                                    <span asp-validation-for="Email" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3-5">
                                    <label asp-for="PhoneNumber" class="form-label fw-medium"></label>
                                    <input asp-for="PhoneNumber" class="form-control custom-gray-input" />
                                    <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="row justify-content-between mb-3">
                                <div class="col-md-2-5">
                                    <label asp-for="DateOfBirth" class="form-label fw-medium"></label>
                                    <input asp-for="DateOfBirth" type="date" class="form-control custom-gray-input" />
                                    <span asp-validation-for="DateOfBirth" class="text-danger small"></span>
                                </div>
                                <div class="col-md-2-5">
                                    <label asp-for="Gender" class="form-label fw-medium"></label>
                                    <select asp-for="Gender" class="form-select custom-gray-input" asp-items="ViewBag.GenderList"></select>
                                    <span asp-validation-for="Gender" class="text-danger small"></span>
                                </div>
                                <div class="col-md-2-5">
                                    <label asp-for="Role" class="form-label fw-medium"></label>
                                    <select asp-for="Role" class="form-select custom-gray-input" asp-items="ViewBag.RoleList"></select>
                                    <span asp-validation-for="Role" class="text-danger small"></span>
                                </div>
                                <div class="col-md-2-5">
                                    <label asp-for="Status" class="form-label fw-medium"></label>
                                    <select asp-for="Status" class="form-select custom-gray-input" asp-items="ViewBag.StatusList"></select>
                                    <span asp-validation-for="Status" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
        </div>
        <div class="row gx-4 gy-3 justify-content-between">
            <div class="col-md-12">
                <div class="row gx-4 gy-3 justify-content-between">
                    <div class="card shadow mb-3">
                        <div class="card-header text-black fs-5 d-flex align-items-center gap-2">
                            <i class="fas fa-user-cog text-conflowerblue"></i>
                            <span>Tài khoản</span>
                        </div>
                        <div class="card-body">
                            <div class="row d-flex gap-4 mb-3">
                                <div class="col-md-4 mb-3">
                                    <label asp-for="Username" class="form-label fw-medium"></label>
                                    <input asp-for="Username" class="form-control custom-gray-input" />
                                    <span asp-validation-for="Username" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="Password" class="form-label fw-medium"></label>
                                    <input type="password" asp-for="Password" class="form-control custom-gray-input" />
                                    <span asp-validation-for="Password" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row gx-4 gy-3 justify-content-between">
            <div class="col-md-12">
                <div class="row gx-4 gy-3 justify-content-between">
                    <div class="col-md-12">
                        <div class="card shadow mb-3">
                            <div class="card-header text-black fs-5 d-flex align-items-center gap-2">
                                <i class="fas fa-map-marker-alt text-conflowerblue"></i>
                                <span>Địa chỉ</span>
                            </div>
                            <div class="card-body">
                                <div class="row justify-content-between mb-3">
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.Street" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.Street" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.Street" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.Ward" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.Ward" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.Ward" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.District" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.District" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.District" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="row justify-content-between mb-3">
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.City" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.City" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.City" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.Country" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.Country" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.Country" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3-5">
                                        <label asp-for="@Model.Address.PostalCode" class="form-label fw-medium"></label>
                                        <input asp-for="@Model.Address.PostalCode" class="form-control custom-gray-input" />
                                        <span asp-validation-for="@Model.Address.PostalCode" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="row align-items-center justify-content-between mb-3 gap-4">
                                    @* <div class="col-md-8">
                                        <div class="form-check mt-4">
                                            <input asp-for="@Model.Address.IsDefault" class="form-check-input" type="checkbox" />
                                            <label asp-for="@Model.Address.IsDefault" class="form-check-label">Là địa chỉ mặc định</label>
                                        </div>
                                    </div> *@
                                    <div class="col-md-12 d-flex justify-content-end">
                                        <button type="button" id="btnAddAddress" class="btn-custom bg-conflowerblue px-4">Thêm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row gx-4 gy-3 justify-content-between">
            <div class="col-md-12">
                <div class="row gx-4 gy-3 justify-content-between">
                    <div class="col-md-12">
                        <div class="table-responsive card shadow mb-3">
                            <table id="addressTable" class="table table-hover align-middle">
                                <thead class="table-background">
                                    <tr>
                                        <th></th>
                                        <th>Địa chỉ</th>
                                        <th>Phường/xã</th>
                                        <th>Quận/huyện</th>
                                        <th>Thành phố</th>
                                        <th>Quốc gia</th>
                                        <th>Mã bưu chính</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn-custom bg-conflowerblue px-4">Lưu</button>
        </div>
    </form>
</div>
@section scripts{
    <script>
        let addressIndex = 0;

        document.getElementById("btnAddAddress").addEventListener("click", function () {
            const street = document.getElementById("Address_Street").value.trim();
            const ward = document.getElementById("Address_Ward").value.trim();
            const district = document.getElementById("Address_District").value.trim();
            const city = document.getElementById("Address_City").value.trim();
            const country = document.getElementById("Address_Country").value.trim();
            const postalCode = document.getElementById("Address_PostalCode").value.trim();
            const isDefault = document.getElementById("Address_IsDefault").checked;

            // Validate
            if (!street || !city || !country) {
                alert("Vui lòng điền đầy đủ địa chỉ, thành phố và quốc gia.");
                return;
            }

            const tbody = document.querySelector("#addressTable tbody");
            const newRow = document.createElement("tr");

            newRow.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input" ${isDefault === true ? "checked" : ""} disabled />
                    <input type="hidden" name="Addresses[${addressIndex}].IsDefault" value="${isDefault}" />
                </td>
                <td> 
                    ${street}
                    <input type="hidden" name="Addresses[${addressIndex}].Street" value="${street}" />
                </td>
                <td>
                    ${ward}
                    <input type="hidden" name="Addresses[${addressIndex}].Ward" value="${ward}" />
                </td>
                <td>
                    ${district}
                    <input type="hidden" name="Addresses[${addressIndex}].District" value="${district}" />
                </td>
                <td>
                    ${city}
                    <input type="hidden" name="Addresses[${addressIndex}].City" value="${city}" />
                </td>
                <td>
                    ${country}
                    <input type="hidden" name="Addresses[${addressIndex}].Country" value="${country}" />
                </td>
                <td>
                    ${postalCode}
                    <input type="hidden" name="Addresses[${addressIndex}].PostalCode" value="${postalCode}" />
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btnDeleteAddress">Xoá</button>
                </td>
            `;

            tbody.appendChild(newRow);
            addressIndex++;

            // Clear input sau khi thêm
            document.getElementById("Address_Street").value = "";
            document.getElementById("Address_Ward").value = "";
            document.getElementById("Address_District").value = "";
            document.getElementById("Address_City").value = "";
            document.getElementById("Address_Country").value = "";
            document.getElementById("Address_PostalCode").value = "";
            document.getElementById("Address_IsDefault").checked = false;
        });

        // Xử lý xóa dòng
        document.querySelector("#addressTable tbody").addEventListener("click", function (e) {
            if (e.target.classList.contains("btnDeleteAddress")) {
                e.target.closest("tr").remove();
                resetAddressIndexes();
            }
        });

        // Reset lại index sau khi xoá để tránh lỗi khi bind
        function resetAddressIndexes() {
            const rows = document.querySelectorAll("#addressTable tbody tr");
            addressIndex = 0;
            rows.forEach(row => {
                const inputs = row.querySelectorAll("input[name]");
                inputs.forEach(input => {
                    const name = input.name;
                    const newName = name.replace(/Addresses\[\d+\]/, `Addresses[${addressIndex}]`);
                    input.name = newName;
                });
                addressIndex++;
            });
        }
    </script>
}